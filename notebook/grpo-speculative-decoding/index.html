<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Speculative Decoding for GRPO | Sudarsh Kunnavakkam</title>
    <meta name="description"
        content="Using speculative decoding to try speeding up GRPO">
    <meta name="author" content="Sudarsh Kunnavakkam">

    <link rel="canonical" href="https://sudarsh.com/notebook/grpo-speculative-decoding/">

    <!-- Reenie Beanie for EVERYTHING -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Reenie+Beanie&display=swap" rel="stylesheet">
    <!-- Recursive for CODE -->
    <link href="https://fonts.googleapis.com/css2?family=Recursive:CASL,CRSV,MONO@1,1,0.5&display=swap"
        rel="stylesheet">

    <script data-goatcounter="https://skunnavakkam.goatcounter.com/count" async src="//gc.zgo.at/count.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css"
        integrity="sha384-n8MVd4RsNIU0tAv4ct0nTaAbDJwPJzDEaqSD1odI+WdtXRGWt2kTvGFasHpSy3SV" crossorigin="anonymous">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"
        integrity="sha384-XjKyOOlGwcjNTAIQHIpgOno0Hl1YQqzUOEleOLALmuqehneUG+vnGctmUb0ZY0l8"
        crossorigin="anonymous"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"
        integrity="sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05" crossorigin="anonymous"
        onload="renderMathInElement(document.body);"></script>

    <!-- Twitter Card Meta Tags -->
    <meta name="twitter:card" content="summary" />
    <meta name="twitter:title" content="Speculative Decoding for GRPO" />
    <meta name="twitter:description"
        content="Using speculative decoding to try speeding up GRPO" />
    <meta name="twitter:url" content="https://sudarsh.com" />
    

    <style>
        :root {
            --paper-bg: #fdfdfd;
            --ink-color: #2a2b2e;
            --ink-secondary: #4a4b4e;
            --highlight: rgba(225, 182, 14, 0.35);
            --highlight-solid: #e1b60e;
        }

        /* Reset box sizing */
        *,
        *::before,
        *::after {
            box-sizing: border-box;
        }

        body {
            font-family: 'Reenie Beanie', cursive;
            font-size: 26px;
            /* Handwriting size */
            line-height: 1.4;
            margin: 0 auto;
            /* Center the body horizontally */

            /* Match blog metrics exactly */
            padding: 30px;
            max-width: max(60%, 600px);

            color: var(--ink-color);
            background-color: var(--paper-bg);
            /* Subtle noise */
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.05'/%3E%3C/svg%3E");

            text-align: left;
            position: relative;
            min-height: 100vh;
        }

        /* Typography */
        h1,
        h2,
        h3,
        h4,
        h5,
        h6 {
            font-family: 'Reenie Beanie', cursive;
            font-weight: 500;
            margin-bottom: 6px;
            color: var(--ink-color);
        }

        /* EXACT MATCH TO BLOG TITLE POSITION */
        .title {
            font-size: 52px;
            margin-bottom: 6px;
            font-weight: 700;
        }

        h1 {
            font-size: 42px;
            font-weight: bold;
        }

        h2 {
            font-size: 36px;
            font-weight: bold;
        }

        h3 {
            font-size: 30px;
            font-weight: bold;
        }

        h4 {
            font-size: 28px;
            text-decoration: underline;
        }

        p {
            margin: 0 0 15px 0;
            /* Match blog paragraph spacing */
        }

        /* Messy Highlighter Effect */
        a {
            color: var(--ink-color);
            text-decoration: none;
            border-bottom: none;

            background-image: linear-gradient(to right,
                    rgba(225, 182, 14, 0.4),
                    rgba(225, 182, 14, 0.6) 20%,
                    rgba(225, 182, 14, 0.5) 80%,
                    rgba(225, 182, 14, 0.4));
            background-size: 100% 0.5em;
            /* Thick stroke */
            background-position: 0 88%;
            background-repeat: no-repeat;

            transition: background-size 0.2s, background-color 0.2s;
            border-radius: 2px 2px 0 0;
        }

        a:hover {
            background-size: 100% 100%;
            /* Fill up on hover */
            background-color: rgba(225, 182, 14, 0.1);
            /* Subtle fill */
            color: var(--ink-color);
        }

        /* NAV LINKS - Below Title */
        .nav-links {
            display: flex;
            gap: 15px;
            margin-bottom: 0px;
            width: 100%;
            align-items: baseline;
            /* Ensure text baseline alignment */
            margin-top: 0;
        }

        .nav-back {
            color: var(--ink-color);
            font-size: 22px;
            text-decoration: none;
            line-height: 1.0;
            /* Tight line height */
            display: inline-block;

            /* Apply highlighter */
            background-image: linear-gradient(to right,
                    rgba(225, 182, 14, 0.4),
                    rgba(225, 182, 14, 0.6));
            background-size: 100% 0.4em;
            background-position: 0 88%;
            background-repeat: no-repeat;
            border-bottom: none;
        }

        .nav-back:hover {
            background-size: 100% 100%;
        }

        .meta {
            font-size: 22px;
            color: var(--ink-secondary);
            margin-bottom: 15px;
            display: block;
        }

        hr {
            border: none;
            border-top: 1px solid #eee;
            /* Match blog hr */
            margin: 20px 0;
        }

        /* Images */
        .photo-wrapper {
            position: relative;
            display: block;
            margin: 32px auto;
            max-width: min(700px, 100% - 20px);
            padding: 12px;
            background: #fff;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.06);
            transform: rotate(-0.5deg);
        }

        img:not(.photo-wrapper img) {
            display: block;
            margin: 32px auto;
            max-width: 100%;
            border-radius: 2px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.06);
        }

        .photo-wrapper img {
            display: block;
            width: 100%;
            height: auto;
        }

        .photo-wrapper::before,
        .photo-wrapper::after {
            content: '';
            position: absolute;
            width: 50px;
            height: 24px;
            background: rgba(255, 255, 255, 0.6);
            border: 1px solid rgba(200, 200, 200, 0.2);
            z-index: 10;
        }

        .photo-wrapper::before {
            top: -10px;
            left: 20px;
            transform: rotate(-3deg);
        }

        .photo-wrapper::after {
            top: -10px;
            right: 20px;
            transform: rotate(3deg);
        }

        pre {
            padding: 16px;
            font-family: 'Recursive', monospace;
            font-size: 18px;
            /* Adjusted size for Recursive */
            background: #fff;
            border: 1px solid rgba(0, 0, 0, 0.05);
            box-shadow: 2px 2px 0 rgba(0, 0, 0, 0.03);
            margin: 32px 0;
            line-height: 1.5;
            white-space: pre-wrap;
            transform: rotate(0.2deg);
            color: var(--ink-color);
        }

        code {
            font-family: 'Recursive', monospace;
            font-size: 0.9em;
            /* slightly smaller to fit in text */
        }

        p code,
        li code {
            /* Messy Highlighter Background */
            background-image: linear-gradient(to right,
                    rgba(225, 182, 14, 0.4),
                    rgba(225, 182, 14, 0.6) 20%,
                    rgba(225, 182, 14, 0.5) 80%,
                    rgba(225, 182, 14, 0.4));
            background-size: 100% 85%;
            background-position: 0 60%;
            background-repeat: no-repeat;

            padding: 2px 4px;
            border-radius: 2px;

            /* Ensure effect wraps correctly */
            -webkit-box-decoration-break: clone;
            box-decoration-break: clone;
        }

        ul,
        ol {
            margin: 0 0 1.5em 0;
            padding-left: 20px;
        }

        li {
            margin-bottom: 8px;
            padding-left: 0;
        }

        ul li::marker {
            color: var(--ink-color);
            content: '- ';
        }

        blockquote {
            margin: 20px 0;
            padding: 10px 20px;

            /* Messy Highlighter Background */
            background-image: linear-gradient(to right,
                    rgba(225, 182, 14, 0.3),
                    rgba(225, 182, 14, 0.5) 20%,
                    rgba(225, 182, 14, 0.4) 80%,
                    rgba(225, 182, 14, 0.3));

            border-left: none;
            font-style: italic;
            color: var(--ink-secondary);
        }

        /* Footnotes */
        .footnotes {
            margin-top: 36px;
            padding-top: 12px;
            border-top: 1px solid rgba(0, 0, 0, 0.08);
            font-size: 0.85em;
        }

        .footnotes ol {
            padding-left: 20px;
        }

        .footnotes li {
            margin-bottom: 10px;
        }

        .footnote-definition {
            margin-bottom: 10px;
        }

        .footnote-definition p {
            display: inline;
        }

        .footnotes-separator {
            border: none;
            border-top: 1px solid rgba(0, 0, 0, 0.08);
            margin: 36px 0 18px 0;
        }

        .footnote-reference,
        .footnote-ref {
            font-size: 0.75em;
            vertical-align: super;
        }

        .footnote-reference a,
        .footnote-ref a,
        .footnote-backref {
            background-image: none;
            border-bottom: none;
            text-decoration: none;
            padding: 0;
        }

        /* Footer */
        .journal-footer {
            margin-top: 60px;
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            font-size: 20px;
            color: var(--ink-secondary);
            padding-top: 20px;
        }

        @media screen and (max-width: 600px) {
            .title {
                font-size: 36px;
            }

            table {
                display: block;
                overflow-x: auto;
            }
        }
    </style>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            renderMathInElement(document.body, {
                delimiters: [
                    { left: "$$", right: "$$", display: true },
                    { left: "$", right: "$", display: false }
                ],
                throwOnError: false,
                trust: true
            });

            const referenceNodes = document.getElementsByClassName('footnote-reference');
            const referenceLinks = referenceNodes.length
                ? Array.from(referenceNodes).map((node) => node.querySelector('a')).filter(Boolean)
                : Array.from(document.querySelectorAll('sup a[href^="#fn"]'));

            for (const link of referenceLinks) {
                const href = link.getAttribute('href');
                if (!href || !href.startsWith('#')) continue;
                const id = href.slice(1);
                if (!link.getAttribute('id')) {
                    link.setAttribute('id', `${id}_ref`);
                }
            }

            const definitionNodes = document.getElementsByClassName('footnote-definition');
            const definitionItems = definitionNodes.length
                ? Array.from(definitionNodes)
                : Array.from(document.querySelectorAll('.footnotes li[id]'));

            for (const footnote of definitionItems) {
                const id = footnote.getAttribute('id');
                if (!id || footnote.querySelector('.footnote-backref')) continue;
                const backReference = document.createElement('a');
                backReference.className = 'footnote-backref';
                backReference.setAttribute('href', `#${id}_ref`);
                backReference.textContent = '↩';
                footnote.append(backReference);
            }

            const definitionBlocks = document.querySelectorAll('.footnote-definition');
            for (const definition of definitionBlocks) {
                const label = definition.querySelector('.footnote-definition-label');
                const paragraph = definition.querySelector('p');
                if (!label || !paragraph) continue;
                if (!paragraph.contains(label)) {
                    paragraph.prepend(label, ' ');
                }
            }

            const existingSeparator = document.querySelector('.footnotes-separator');
            if (!existingSeparator) {
                const footnotesContainer = document.querySelector('.footnotes');
                const firstDefinition = document.querySelector('.footnote-definition');
                const insertTarget = footnotesContainer || firstDefinition;
                if (insertTarget) {
                    const separator = document.createElement('hr');
                    separator.className = 'footnotes-separator';
                    insertTarget.parentNode.insertBefore(separator, insertTarget);
                }
            }

            document.querySelectorAll('img:not(.no-tape)').forEach(function (img) {
                if (img.parentElement.classList.contains('photo-wrapper')) return;
                const wrapper = document.createElement('div');
                wrapper.className = 'photo-wrapper';
                const rotation = (Math.random() - 0.5) * 2;
                wrapper.style.transform = `rotate(${rotation}deg)`;
                img.parentNode.insertBefore(wrapper, img);
                wrapper.appendChild(img);
            });
        });
    </script>
</head>

<body>
    <h1 class="title">Speculative Decoding for GRPO</h1>

    <div class="nav-links">
        <a href="../" class="nav-back">
            < back to all posts</a>
    </div>

    <p class="meta">
        scribbled on August 08, 2025
    </p>

    <hr>

    <p>Recently, long-form reasoning traces accompany many of our frontier language models trained with group relative policy optimization (GRPO). Like with PPO and other transformer reinforcement learning methods, training is often bottlenecked on inference performance. However, unlike other transformer RL methods, GRPO tends to produce much longer reasoning traces.</p>
<p>In language model inference, you have two key phases: <em>prefill</em> and <em>decode</em>. The prefill phase fills in the context window into the KV cache etc, and the decode phase is responsible for generating new tokens. Since the prefill phase is paralleized over all tokens in the context window, it is generally far more compute bottlenecked. However, the decode phase is sequential, so it’s generally bound by memory bandwidth.</p>
<p>In speculative decoding, a smaller draft model (somethings just an adapter on the last layer of the model) is used to generate some $n$ tokens in a sequence, after which the full model is used to check the validity of the draft model’s output. Since the full model checks $n &gt; 1$ tokens, we can hope that this allows for memory to be a lesser bottleneck when compared to compute, since the same set of weights are able to be used for $n$ tokens instead of $1$. </p>
<p>Since reasoning traces are often long, on the order of $10,000$ tokens for frontier models like DeepSeek-R1, reasoning models are likely to be more decode, and thus memory, bottlenecked than other RL models. This justifies exploring using speculative decoding in order to speed up inference for training. </p>
<p>To ensure that the draft model is able to generate tokens close enough to the base model, we continuously update the draft model’s weights to match the base model’s generations. This is done by using a subset of the base model’s generations during GRPO and updating the draft model’s policy.</p>
<h2 id="implementation">Implementation</h2>
<p>We load Qwen3-4B into SGLang with an EAGLE3 draft model. The EAGLE draft model is a 1-layer adapter on the last layer of the base model to allow for multi-token generations. </p>
<p>At each step, we generate $n$ rollouts from the base model. We then calculate advantages </p>
<pre data-lang="python" style="background-color:#fafafa;color:#383a42;" class="language-python "><code class="language-python" data-lang="python"><span>advantage </span><span style="color:#a626a4;">= </span><span>(rewards </span><span style="color:#a626a4;">- </span><span>r_mean) </span><span style="color:#a626a4;">/ </span><span>(r_std </span><span style="color:#a626a4;">+ </span><span style="color:#c18401;">1e-8</span><span>)
</span></code></pre>
<p>After tokenizing, we create our loss ratio <code>ratio = torch.exp(new_logprobs - old_logprobs)</code> and clip loss like in the GRPO paper </p>
<pre data-lang="python" style="background-color:#fafafa;color:#383a42;" class="language-python "><code class="language-python" data-lang="python"><span>pg_loss </span><span style="color:#a626a4;">= -</span><span>torch.</span><span style="color:#e45649;">min</span><span>(
</span><span>    ratio </span><span style="color:#a626a4;">* </span><span>advantage, torch.</span><span style="color:#e45649;">clamp</span><span>(ratio, </span><span style="color:#c18401;">1 </span><span style="color:#a626a4;">- </span><span>eps, </span><span style="color:#c18401;">1 </span><span style="color:#a626a4;">+ </span><span>eps) </span><span style="color:#a626a4;">* </span><span>advantage
</span><span>).</span><span style="color:#e45649;">mean</span><span>()
</span></code></pre>
<p>We then minimize the loss through AdamW.</p>
<p>Then, once every <code>train_draft_model</code> steps, we update the draft model’s weights to ensure that it suffices as a draft model. SGLang’s Specforge takes care of a lot of this, and this step essentially looks like <code>scripts/train_eagle3_online.py</code> in the Specforge repo.</p>
<p>Then, we save both sets of weights to disk, and synchronize the weights to the SGLang server. We sync base model weights every step, and draft model weights every <code>train_draft_model</code> steps.</p>
<h2 id="results">Results</h2>
<p>Due to CUDA versioning errors, and specifically the <code>undefined symbol: _ZN3c104cuda9SetDeviceEab</code> error I’ve been perpetually running into, I’ve been unable to run the full training loop. I’m going to weight for a patch on the SGLang / vLLM side before running the script. However, it should work great. </p>


    <div class="journal-footer">
        <div class="page-number">08</div>
        <div class="signature">- SUDARSH</div>
    </div>
</body>

</html>